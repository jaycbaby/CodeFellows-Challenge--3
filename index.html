<!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>hello-backbonejs</title>
  </head>
  <body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.1.6/underscore-min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/backbone.js/0.3.3/backbone-min.js"></script>

    <!--<script src="...backboneTut.js..." type="text/javascript"></script>-->
<script>
(function($){
    var editingId = -1;
    
    Backbone.sync = function(method, model, success, error){
        success();
    }
    
    var Item = Backbone.Model.extend({
        defaults: {
            fname: '',
            lname: '',
            email: 'n/a',
            id: ''
        }
    });
    
    var List = Backbone.Collection.extend({
        model: Item
    });
    
    var ItemView = Backbone.View.extend({
        tagName: 'li', // name of (orphan) root tag in this.el
        
        events: {
            'click span.edits':  'edit',
            'click span.delete': 'remove'
        },    
        
        initialize: function(){
            _.bindAll(this, 'render', 'unrender', 'edit', 'remove'); // every function that uses 'this' as the current object should be in here
            
            this.model.bind('change', this.render);
            this.model.bind('remove', this.unrender);
        },
        render: function(){
            $(this.el).html('<span style="color:black;" id="'+this.model.get('id')+'">'+this.model.get('fname')+' '+this.model.get('lname')+', '+this.model.get('email')+'</span> &nbsp; &nbsp; <span class="edits" style="font-family:sans-serif; color:blue; cursor:pointer;">[edit]</span> <span class="delete" style="cursor:pointer; color:red; font-family:sans-serif;">[delete]</span>');
      return this; // for chainable calls, like .render().el
        },
        unrender: function(){
            $(this.el).remove();
        },
        edit: function(){
            var id = this.model.get('id');
            $( ".edit" ).show();
            
            $( "#"+id ).css("background-color", "pink");
            $( "#fnameEdit" ).val(this.model.get('fname'));
            $( "#lnameEdit" ).val(this.model.get('lname'));
            $( "#emailEdit" ).val(this.model.get('email'));
            editingId = this.model.get('id');
            
        },
        remove: function(){
            this.model.destroy();
        }
    });
    
    var ListView = Backbone.View.extend({
        el: $('body'), // attaches `this.el` to an existing element.

        events: {
            'click button#add': 'addItem',
            'click button#save': 'editItem'
        },
        initialize: function(){
            _.bindAll(this, 'render', 'addItem', 'appendItem'); // fixes loss of context for 'this' within methods
    
            this.collection = new List();
            this.collection.bind('add', this.appendItem); // collection event binder
            
            this.counter = 0;
            this.render(); // not all views are self-rendering. This one is.
        },
        
        
        render: function(){
            
            $(this.el).append('First name: <input type="text" name="fname" id="fname"><br>');
            $(this.el).append('Last name: <input type="text" name="lname" id="lname"><br>');
            $(this.el).append('E-Mail: <input type="text" name="email" id="email"><br>');
            $(this.el).append("<button id='add'>Add user</button>");
            $(this.el).append("<ul></ul>");
            
            $(this.el).append('<div class="edit" style="position:fixed;top:150px;left:400px;">');
            $( ".edit" ).append('First name: <input type="text" name="fname" id="fnameEdit"><br>');
            $( ".edit" ).append('Last name: <input type="text" name="lname" id="lnameEdit"><br>');
            $( ".edit" ).append('E-Mail: <input type="text" name="email" id="emailEdit"><br>');
            $( ".edit" ).append("<button id='save'>Save Changes</button>");
            
            
            $( ".edit" ).hide();
            _(this.collection.models).each(function(item){ // in case collection is not empty
                self.appendItem(item);
            }, this);
        },
        
        addItem: function(){
            this.counter++;
            var item = new Item();
            item.set({
                fname: $( "#fname" ).val(),
                lname: $( "#lname" ).val(),
                email: $( "#email" ).val(),
                id: this.counter // modify item defaults
            });
            this.collection.add(item); // add item to collection; view is updated via event 'add'
        },
        
        editItem: function() {
            this.collection.each( function(model) {
                if(model.get('id') == editingId){
                    model.set({
                        fname: $( "#fnameEdit" ).val(),
                        lname: $( "#lnameEdit" ).val(),
                        email: $( "#emailEdit" ).val(),
                    });
                }
            });
            $( "#"+editingId ).css("background-color", "white");
            editingId = -1;
            $( ".edit" ).hide();
        },
        
        appendItem: function(item){
            var itemView = new ItemView({
                model: item
            });
            $('ul', this.el).append(itemView.render().el);
        }
    });

    var listView = new ListView();
})(jQuery);
</script>
  </body>
  </html>